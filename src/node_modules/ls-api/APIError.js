var assert = require('ls-assert').assert;

class APIError extends Error {
	constructor(request) {
		assert(request instanceof XMLHttpRequest);
		assert(request.status !== 200);

		super('', 0, 0);
		if (Error.captureStackTrace) {
			Error.captureStackTrace(this, APIError);
		}

		this.request = request;
		if (
			this.request.getResponseHeader('Content-Type') === 'application/json'
			&& this.request.responseText !== ''
		) {
			this.data = JSON.parse(this.request.responseText);
		} else {
			this.data = null;
		}
	}

	is(status) { return this.request.status === status; }
	get_status() { return this.request.status }
	get_message() { return this.data.e_msg; }

	toString() {
		let ret = '';
		if (this.data !== null) {
			ret =  `\nAPI Error (${this.request.status}): ${this.data.e_msg}\n`;
			ret += `\tat ${this.data.thrown_at}\n`;
			ret += 'Server stack trace:\n';
			ret += `\t${this.data.e_trace.replace('\n', '\n\t')}\n\n`;
		} else {
			ret = `\nAPI Error (${this.request.status})\n`;
		}
		return ret;
	}
}
exports.APIError = APIError;
